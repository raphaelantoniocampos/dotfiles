#!/bin/sh

# Arquivo de progresso
PROGRESS_FILE=~/.setup_progress
SCRIPT_VERSION=1.0

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Carregar progresso anterior
if [ -f "$PROGRESS_FILE" ]; then
    . "$PROGRESS_FILE"
else
    CURRENT_STEP=0
fi

# Funções de utilidade
save_progress() {
    echo "CURRENT_STEP=$1" > "$PROGRESS_FILE"
    echo "SCRIPT_VERSION=$SCRIPT_VERSION" >> "$PROGRESS_FILE"
}

show_menu() {
    while true; do
        printf "\n${YELLOW}$1${NC}\n"
        printf "1) Continuar\n"
        printf "2) Pular\n"
        printf "3) Cancelar\n"
        read -p "Escolha (1/2/3): " choice
        
        case $choice in
            1) return 0 ;;
            2) return 1 ;;
            3) exit 0 ;;
            *) echo "${RED}Opção inválida!${NC}" ;;
        esac
    done
}

# Passo 0: Atualização inicial
if [ "$CURRENT_STEP" -eq 0 ]; then
    if show_menu "Passo 0: Atualizar sistema e instalar git"; then
        sudo pacman -Syu --noconfirm
        sudo pacman -S --noconfirm git
    fi
    save_progress 1
fi

# Passo 1: Clonar dotfiles
if [ "$CURRENT_STEP" -eq 1 ]; then
    if show_menu "Passo 1: Clonar repositório de dotfiles"; then
        git clone https://github.com/example/dotfiles ~/dotfiles || \
        echo "${RED}Falha ao clonar repositório${NC}"
    fi
    save_progress 2
fi

# Passo 2: Xorg e drivers
if [ "$CURRENT_STEP" -eq 2 ]; then
    if show_menu "Passo 2: Instalar Xorg e configurar drivers"; then
        sudo pacman -S --noconfirm xorg
        
        echo "\n${YELLOW}=== AJUDA PARA DRIVERS ===${NC}"
        echo "Execute para ver seu adaptador gráfico:"
        echo "lspci -v -nn -d ::03xx"
        echo "\nInstale o driver apropriado manualmente:"
        echo "- Intel: xf86-video-intel"
        echo "- Nvidia: nvidia ou nvidia-dkms"
        echo "- AMD: xf86-video-amdgpu"
        echo "\nPressione Enter quando terminar..."
        read _
    fi
    save_progress 3
fi

# Passo 3: Escolher compositor
if [ "$CURRENT_STEP" -eq 3 ]; then
    if show_menu "Passo 3: Instalar compositor de janelas"; then
        echo "${YELLOW}Escolha o compositor:${NC}"
        echo "1) i3 (Xorg)"
        echo "2) Hyprland (Wayland)"
        read -p "Sua escolha (1/2): " wm_choice

        case $wm_choice in
            1) sudo pacman -S --noconfirm i3 rofi polybar picom ;;
            2) sudo pacman -S --noconfirm hyprland hyprpaper hypridle hyprlock wofi waybar ;;
            *) echo "${RED}Opção inválida, pulando...${NC}" ;;
        esac
    fi
    save_progress 4
fi

# Passo 4: Display Manager
if [ "$CURRENT_STEP" -eq 4 ]; then
    if show_menu "Passo 4: Configurar Display Manager (ly)"; then
        sudo pacman -S --noconfirm ly
        sudo systemctl enable ly --now
    fi
    save_progress 5
fi

# Passo 5: Customização
if [ "$CURRENT_STEP" -eq 5 ]; then
    if show_menu "Passo 5: Aplicar customizações"; then
        sudo pacman -S --noconfirm stow neovim starship
        if [ -d ~/dotfiles ]; then
            cd ~/dotfiles && stow .
        else
            echo "${RED}Pasta dotfiles não encontrada!${NC}"
        fi
    fi
    save_progress 6
fi

# Passo 6: Outros programas
if [ "$CURRENT_STEP" -eq 6 ]; then
    if show_menu "Passo 6: Instalar programas adicionais"; then
        sudo pacman -S --noconfirm xclip firefox
    fi
    save_progress 7
fi

# Finalização
echo "${GREEN}\nSetup completo!${NC}"
rm -f "$PROGRESS_FILE"
